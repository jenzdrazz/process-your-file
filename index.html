<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Viewer Dokumen</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; }
    #preview img, #preview .text-page {
      width: 200px; margin: 5px; border: 1px solid #ccc; padding: 5px; display: inline-block; white-space: pre-wrap;
    }
    #loading { display: none; font-weight: bold; color: green; }
    .btn { margin: 10px; padding: 10px 15px; cursor: pointer; border: none; border-radius: 5px; }
    .btn-blue { background: #007bff; color: white; }
    .btn-green { background: #28a745; color: white; }
  </style>
</head>
<body>
  <h2>Upload & Convert Dokumen</h2>
  <input type="file" id="fileInput" accept=".pdf,.txt,.docx">
  <br><br>
  <button class="btn btn-blue" onclick="showGallery()">Lihat Galeri</button>
  <button class="btn btn-green" onclick="downloadZip()">Download ZIP</button>
  <p id="loading">‚è≥ Sedang diproses...</p>
  <div id="preview"></div>

  <script>
    let images = []; // untuk PDF
    let texts = [];  // untuk TXT & DOCX

    async function renderPDF(file) {
      const fileReader = new FileReader();
      return new Promise((resolve) => {
        fileReader.onload = async function() {
          const typedArray = new Uint8Array(this.result);
          const pdf = await pdfjsLib.getDocument(typedArray).promise;
          let result = [];
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 2 });
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: context, viewport }).promise;
            result.push(canvas.toDataURL("image/png"));
          }
          resolve(result);
        };
        fileReader.readAsArrayBuffer(file);
      });
    }

    async function renderTXT(file) {
      const text = await file.text();
      const lines = text.split("\n");
      let pages = [];
      let chunk = [];
      lines.forEach((line, i) => {
        chunk.push(line);
        if (chunk.length >= 40 || i === lines.length - 1) {
          pages.push(chunk.join("\n"));
          chunk = [];
        }
      });
      return pages;
    }

    async function renderDOCX(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = async function(event) {
          const arrayBuffer = event.target.result;
          mammoth.extractRawText({ arrayBuffer }).then(result => {
            const lines = result.value.split("\n");
            let pages = [];
            let chunk = [];
            lines.forEach((line, i) => {
              chunk.push(line);
              if (chunk.length >= 40 || i === lines.length - 1) {
                pages.push(chunk.join("\n"));
                chunk = [];
              }
            });
            resolve(pages);
          });
        };
        reader.readAsArrayBuffer(file);
      });
    }

    async function showGallery() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Pilih file dulu!");
      document.getElementById("loading").style.display = "block";
      const ext = file.name.split(".").pop().toLowerCase();
      const preview = document.getElementById("preview");
      preview.innerHTML = "";

      if (ext === "pdf") {
        images = await renderPDF(file);
        images.forEach(img => {
          const image = document.createElement("img");
          image.src = img;
          preview.appendChild(image);
        });
      } else if (ext === "txt") {
        texts = await renderTXT(file);
        texts.forEach(page => {
          const div = document.createElement("div");
          div.className = "text-page";
          div.textContent = page;
          preview.appendChild(div);
        });
      } else if (ext === "docx") {
        texts = await renderDOCX(file);
        texts.forEach(page => {
          const div = document.createElement("div");
          div.className = "text-page";
          div.textContent = page;
          preview.appendChild(div);
        });
      } else {
        alert("Format tidak didukung!");
      }
      document.getElementById("loading").style.display = "none";
    }

    async function downloadZip() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Pilih file dulu!");
      document.getElementById("loading").style.display = "block";
      const ext = file.name.split(".").pop().toLowerCase();
      let zip = new JSZip();

      if (ext === "pdf") {
        images = await renderPDF(file);
        images.forEach((img, i) => {
          const base64 = img.split(",")[1];
          zip.file("page_" + (i+1) + ".png", base64, {base64: true});
        });
      } else if (ext === "txt") {
        texts = await renderTXT(file);
        texts.forEach((page, i) => {
          zip.file("page_" + (i+1) + ".txt", page);
        });
      } else if (ext === "docx") {
        texts = await renderDOCX(file);
        texts.forEach((page, i) => {
          zip.file("page_" + (i+1) + ".txt", page);
        });
      }

      zip.generateAsync({type:"blob"}).then(function(content) {
        saveAs(content, "dokumen.zip");
        document.getElementById("loading").style.display = "none";
      });
    }
  </script>
</body>
</html>
